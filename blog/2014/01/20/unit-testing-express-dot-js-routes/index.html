
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Unit Testing Express.js Routes - The Attic</title>
  <meta name="author" content="Andrew Winder">

  
  <meta name="description" content="Unit Testing Express.js Routes January 20, 2014 @ 10:00 PM EST express.js, mocha, node.js, testing Unit testing of model-type functionality in Node &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://awinder.github.io/blog/2014/01/20/unit-testing-express-dot-js-routes">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/stylesheets/bootstrap.min.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/stylesheets/bootstrap-responsive.min.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/stylesheets/font-awesome.min.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/stylesheets/attic.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="The Attic" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/lib/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-44769789-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <div class="container-fluid">
    <div class="row header">
      <nav>
  <a href="/"><h2 class="lede span4">The Attic</h2></a>
  <ul class="span4 visible-phone social">
    <li class="photo"></li>
  </ul>
  <ul class="span4 visible-tablet social">
    <li class="twitter"><a href="http://www.twitter.com/awinder"><i class="icon-4x icon-twitter"></i></a></li>
    <li class="rss"><a href="/atom.xml"><i class="icon-4x icon-rss"></i></a></li>
    <li class="linkedin"><a href="http://www.linkedin.com/in/ajwinder"><i class="icon-4x icon-linkedin"></i></a></li>
  </ul>
  <ul class="pull-right visible-desktop social">
    <li class="twitter"><a href="http://www.twitter.com/awinder"><i class="icon-2x icon-twitter"></i>@awinder</a></li>
    <li class="rss"><a href="/atom.xml"><i class="icon-2x icon-rss"></i> rss</a></li>
    <li class="linkedin"><a href="http://www.linkedin.com/in/ajwinder"><i class="icon-2x icon-linkedin"></i> linkedin</a></li>
  </ul>
</nav>


    </div>
    <div class="row-fluid mainbody">
      <div class="sidebar">
        <span class="face"></span>
<span class="byline">Hi, I'm Andrew Winder, and I'm a Web Application developer at <a href="http://www.messagesystems.com">Message Systems</a>.</span>

<ul id="drawer">
  <li><a href="/blog/archives">Archive</a></li>
</ul>
<ul id="social-links">
  <li><a href="http://www.github.com/awinder" class="icon-github">&nbsp;+github</a></li>
  <li class="linkedin visible-phone"><a href="http://www.linkedin.com/in/ajwinder"><i class="icon icon-linkedin"></i> +linkedin</a></li>
  <li class="twitter visible-phone"><a href="http://www.twitter.com/awinder"><i class="icon icon-twitter"></i> @awinder</a></li>
</ul>

      </div>
      <div class="span9">
        <article role="article">
  <h3>Unit Testing Express.js Routes</h3>
  <div class="info">
    <time class="date">January 20, 2014</time>
    <time class="hidden-phone"> @ 10:00 PM EST</time>
    <span class="tags">
      
        <a class='category' href='/blog/categories/express-dot-js/'>express.js</a>, <a class='category' href='/blog/categories/mocha/'>mocha</a>, <a class='category' href='/blog/categories/node-dot-js/'>node.js</a>, <a class='category' href='/blog/categories/testing/'>testing</a>
      
    </span>
  </div>
  <p>Unit testing of model-type functionality in Node has been really straightforward for me so far.  By injecting mocks using wonderful libraries like <a href="https://github.com/thlorenz/proxyquire">Proxyquire</a>, you can smoothly control flow and trigger conditional branches while testing to ensure that you&rsquo;re fully covering a module.  But what happens when you need to test out <a href="http://expressjs.com">Express.js</a> route handlers?  Imagine you have configured a route in an Express.js application like so:</p>

<div><script src='https://gist.github.com/7508239.js?file=index.js'></script>
<noscript><pre><code>var express = require('express')
  , app = exports = module.exports = express()
  , ctrl = require('./controller');

app.get('/', ctrl.test);
</code></pre></noscript></div>


<p>And imagine you have a controller that implements the callback you configured your application with for the &ldquo;/&rdquo; endpoint:</p>

<div><script src='https://gist.github.com/7508239.js?file=controller.js'></script>
<noscript><pre><code>module.exports = {
  test : function(req, res) {
    setTimeout(function() {
      res.send({ testing : true }, 200);
    }, 5000);
  },
}
</code></pre></noscript></div>


<p>The timeout here isn&rsquo;t exactly practical, but it is representative:  Most non-trivial functionality in an Express.js project is going to need to communicate with some system, like a database or caching system, or read from the file system.  In other words:  Something asynchronous!  Asynchronous code is much less straightforward to test because a unit test needs to have some kind of idea when the code you&rsquo;re testing is done.  Unlike testing a synchronous function, which returns to signify that it&rsquo;s completed, you just can&rsquo;t do that with asynchronous logic.  Further complicating this situation is that Express route handlers signal that they are done by calling a method on the Response object, like res.send.  This is a little different from situations where I&rsquo;ve tested my own modules (usually in models) because the events that my models emit are easily subscribed to in the tests.  I can wait for the events to fire in a unit test, inspect any data that is in the event, and then exit the unit test.  What&rsquo;s the right move here?</p>

<p>It&rsquo;s actually relatively straightforward:  I just need to inject a mock Response object into the route handler.  By injecting a mock, I can have some control over what happens once the methods on the response are called.  Because response methods are often called in asynchronous workflows, I&rsquo;ll want a mock that emits an event itself.  Lets see what that might look like:</p>

<div><script src='https://gist.github.com/7508239.js?file=response.mock.js'></script>
<noscript><pre><code>var util = require('util')
  , events = require('events').EventEmitter;

var res = function () {
};

util.inherits(res, events);

res.prototype.send = function(payload, code) {
  this.emit('response', {
    code: code,
    response: payload
  });
}

module.exports = function() {
  return new res();
};</code></pre></noscript></div>


<p>Hopefully this looks as expected.  I&rsquo;m utilizing the EventEmitter prototype that Node.JS provides, and now when the response object&rsquo;s <em>send</em> method is invoked, I fire a <em>response</em> event.  That way, in the unit test, I can attach an event handler to the mock&rsquo;s event, and then kick off the route handler method that I want to test.  Whenever the response methods are actually invoked, the handler in the unit test will invoke, and there we can perform any assertions on the output of our controller&rsquo;s action: the response code and response body.</p>

<div><script src='https://gist.github.com/7508239.js?file=test.spec.js'></script>
<noscript><pre><code>var expect = require('chai').expect
  , res = require('./mocks/response')()
  , testing = require('./controller');

describe('Testing', function(){
  it('Should send an object with a testing key', function(done){
    res.on('response', function(resp) {
      expect(resp.response).to.have.property('testing');
      expect(resp.response.testing).to.equal(true);
      done();
    });
    
    testing.test({}, res);
  });
});
</code></pre></noscript></div>


<p>And just like that, my route handler has unit test coverage.  As the controller gets built out, we&rsquo;ll want to use tools like <a href="https://github.com/thlorenz/proxyquire">Proxyquire</a>, as mentioned before, to inject mocks for our external resources to keep our tests running smoothly and to not duplicate testing efforts.  A unit test for a route handler should exist primarily to test any branching logic or business logic that exists inside the handler itself: Not the branching logic and business logic in the route handlers <em>dependencies</em>.  We try to keep our logic pretty light inside of route handler itself at work, but there are some situations, like in error reporting, where we do branch.  These situations are definitely not trivial, and it&rsquo;s important that we have appropriate testing coverage for it.  And now, we have a straightforward and repeatable method for doing that testing.</p>

</article>        
      </div>
    </div>
    <footer>
      <p>&copy;&nbsp;Andrew Winder, 2013.  All rights reserved.
    </footer>
  </div>  
</body>
</html>
